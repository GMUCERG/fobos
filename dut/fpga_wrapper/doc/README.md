.. _tvgen-label:

Test Vector Generation
**********************

The wrapper receives data from the control board and distributes it into two FIFOs; FIFO_0 and FIFO_1 and 7 16-bit configuration registers conf_reg1 .. conf_reg7.

Once the wrapper prepares the data for the function core, it starts the core which consumes the data in the input FIFOs and produces output.
The wrapper accumulates the output into the output FIFO, FIFO_OUT the expected number of bytes are stored. 
Then, the wrapper returns the data to the control board which forwards it back to the PC.

.. figure::  figures/fobos2-block.png
   :align:   center
   :height: 300 px

   FOBOS2 block diagram


The following is a brief description for the test vector format

Supported instructions
==================

- 00C0 # Fill FIFO_0. The next 16-bits is the length of the data to be sent to the fifo (in bytes) followed by the data itself.
- 00C1 # Fill FIFO_1.
- 008X # Here X stands for the number of configuration register conf_reg_1 .. conf_reg_7. The next 16-bits is value to be stored in the register.
- 0080 # Execute task. Two tasks are supported.
    - 0001 : Run crypto core. This command starts the crypto core and returns the core's output data. The input FIFOs should be already filled and the expected output should be stored in conf_reg_1.
    - 0002 : Generated randomness. Generate randomness and save it in FIFO_RDI. The seed should be already stored in stored in (conf_reg7 || conf_reg_6 || conf_reg_5 || conf_reg_4). The number of 32-bit words to be stored should already be stored in conf_reg_2. Once this command is sent, the wrapper generates the random words and waits for the next commands. After each run of the crypto core, more randomness is genertated and stored in FIFO_RDI waiting for the next run.

FOBOS Protocol Example
----------------------

Here is a typical example of a signle test vector sent to the wrapper split into multiple lines). In this example we store 8 bytes in FIFO_0, 10 bytes in FIFO_1 and we expect 8 bytes to be returned by the core::


    00C0 # Fill FIFO_0 (length in bytes to follow)
    0008 # with 8 bytes of data
    FFFF # the 8 bytes of data
    FFFF
    FFFF
    FFFF
    ####
    00C1 # Fill FIFO_1 (length in bytes to follow)
    000A # with 10 bytes
    0000 # the 10 bytes of data
    0000
    0000
    0000
    0000
    #### 
    0081 # Store data in conf_reg_1 (the expected output size)
    0008 # data to store in reg     (8 bytes of output expected)
    ####
    0080 # Execute task
    0001 # start crypto task 
    ####

Here is a typical eample of configuring the wrapper to generate randomeness before each run of the crypto-core. In this example the we set the number of words to be generated by the PRNG to 16 words, set the seed to 0x7788556633441122.

    0082 # Store data in conf_reg2
    0010 # data to store (number of 32-bit words of randomnes to generate before each run of cryptocore)
    ####
    0084 # Store data in conf_reg4
    7788 # part of the seed
    ####
    0085 # Store data in conf_reg5
    5566 # part of the seed
    ####
    0086 # Store data in conf_reg6
    3344 # part of the seed
    ####
    0087 # Store data in conf_reg7
    1122 # part of the seed
    ####
    0080 # execute task
    0002 # generate randomness task

